#!/usr/bin/env python3
"""
Assistant Message Hook - Speaks all Claude responses via TTS

This hook is triggered whenever Claude sends a message.
It extracts the text and passes it to the ElevenLabs TTS system.
"""

import sys
import json
import subprocess
import re
import os
from pathlib import Path

def clean_text_for_speech(text):
    """
    Clean text to make it more natural for speech.
    - Remove code blocks (just say "code on screen")
    - Simplify technical formatting
    - Keep it conversational
    """
    # Remove code blocks and replace with simple message
    text = re.sub(r'```[\s\S]*?```', '[Code shown on screen]', text)

    # Remove inline code
    text = re.sub(r'`([^`]+)`', r'\1', text)

    # Clean up markdown formatting
    text = re.sub(r'\*\*([^*]+)\*\*', r'\1', text)  # Bold
    text = re.sub(r'\*([^*]+)\*', r'\1', text)      # Italic
    text = re.sub(r'#{1,6}\s', '', text)            # Headers

    # Replace technical notation with speakable versions
    text = re.sub(r'O\(([^)]+)\)', r'O of \1', text)  # O(n) â†’ O of n
    text = re.sub(r'<=', ' less than or equal to ', text)
    text = re.sub(r'>=', ' greater than or equal to ', text)
    text = re.sub(r'!=', ' not equal to ', text)
    text = re.sub(r'==', ' equals ', text)

    # Remove excessive newlines
    text = re.sub(r'\n{3,}', '\n\n', text)

    # Limit length for very long messages (keep first part)
    if len(text) > 1000:
        text = text[:1000] + "... Check your screen for full details."

    return text.strip()

def main():
    try:
        # Read the message data from stdin
        data = json.loads(sys.stdin.read())

        # Extract text content
        text = data.get('text', '')

        if not text:
            return

        # Clean text for speech
        speech_text = clean_text_for_speech(text)

        if not speech_text or speech_text == '':
            return

        # Get path to TTS script
        script_dir = Path(__file__).parent
        tts_script = script_dir / 'elevenlabs_tts.py'

        # Call TTS with silent mode (no console output clutter)
        env = os.environ.copy()
        env['TTS_SILENT_MODE'] = 'true'

        subprocess.run(
            [str(tts_script), speech_text],
            env=env,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )

    except Exception as e:
        # Silently fail - don't break Claude if TTS has issues
        pass

if __name__ == '__main__':
    main()
