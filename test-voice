#!/bin/bash
# Test Voice Transcription
# Shows what Whisper hears so you can verify accuracy

echo "üé§ Voice Transcription Test"
echo "=========================="
echo ""
echo "Current model: $(grep 'whisper_model' .claude/hooks/utils/voice_config.json | cut -d'"' -f4)"
echo "Device: $(grep 'device' .claude/hooks/utils/voice_config.json | cut -d'"' -f4 | tr '[:lower:]' '[:upper:]')"
echo ""
echo "üì¢ Speak clearly into your microphone..."
echo "Suggested test phrase: 'Claude, start session one one'"
echo ""

# Record start time
START=$(date +%s%N)

# Run voice detector and capture output
TEXT=$(./.claude/hooks/utils/voice_detector.py 2>&1 | tee /dev/stderr | tail -1)

# Calculate time
END=$(date +%s%N)
ELAPSED=$(( (END - START) / 1000000 ))  # Convert to milliseconds

echo ""
echo "=========================="
echo "‚úÖ TRANSCRIBED: '$TEXT'"
echo "‚è±Ô∏è  Time: ${ELAPSED}ms"
echo "=========================="
echo ""

if [ -n "$TEXT" ]; then
    echo "Is this what you said? (Y/n)"
    read -r RESPONSE

    if [[ "$RESPONSE" =~ ^[Nn] ]]; then
        echo ""
        echo "Transcription seems inaccurate. Try:"
        echo "  1. Speak more clearly and slowly"
        echo "  2. Check microphone quality"
        echo "  3. Reduce background noise"
        echo "  4. Try different model: ./switch-whisper-model medium"
    else
        echo "‚úÖ Great! Voice system working well!"
    fi
else
    echo "‚ö†Ô∏è  No speech detected or transcription empty"
    echo "Check:"
    echo "  - Microphone is connected"
    echo "  - You spoke loudly enough"
    echo "  - No errors above"
fi
